# Based on https://github.com/kubeflow/katib/blob/release-0.15/cmd/cert-generator/v1beta1/Dockerfile
name: cert-generator
summary: Certificate generator for Katib standalone installation.
description: "Katib cert generator"
version: "v0.15.0_22.04_1"
license: Apache-2.0
base: ubuntu:22.04
build-base: ubuntu:22.04
run-user: _daemon_
services:
  cert-generator:
    override: replace
    summary: "Cert genrator service"
    startup: enabled
    command: ./katib-cert-generator
    working-dir: /app
platforms:
  amd64:

parts:
  cert-generator:
    plugin: go
    source: https://github.com/kubeflow/katib
    source-type: git
    source-tag: "v0.15.0"
    build-snaps:
      - go/1.19/stable
    override-build: |
      go mod download -x
      CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -o katib-cert-generator ./cmd/cert-generator/v1beta1
      mkdir -p ${CRAFT_PART_INSTALL}/app/
      cp -rp katib-cert-generator ${CRAFT_PART_INSTALL}/app/

  security-team-requirement:
    plugin: nil
    override-build: |
      mkdir -p ${CRAFT_PART_INSTALL}/usr/share/rocks
      (echo "# os-release" && cat /etc/os-release && echo "# dpkg-query" && \
        dpkg-query --root=${CRAFT_PROJECT_DIR}/../bundles/ubuntu-22.04/rootfs/ -f '${db:Status-Abbrev},${binary:Package},${Version},${source:Package},${Source:Version}\n' -W) \
        > ${CRAFT_PART_INSTALL}/usr/share/rocks/dpkg.query
